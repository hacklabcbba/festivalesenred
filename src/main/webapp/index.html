<div  data-lift="surround?with=base-wrap;at=content" id="content">
    <lift:head>
        <title>Festivales en Red | Telartes</title>
    </lift:head>
   <div class="inner-wrap" data-lift="HomeSnippet.searchForm">
      <div class="gs-right-btn">
      	<a class="right-off-canvas-toggle right gs-open" href="#" ><img src="/img/buscar.png"/></a> <!-- Off Canvas Menu -->
      </div>
      <aside class="right-off-canvas-menu">
      	<h2>Tipos Festivales</h2>
      	<!-- start accordion -->
				<ul class="accordion" data-accordion>
					<!-- accordion one -->
				  <li class="accordion-navigation">
				    <a href="#panel1a">Categorías</a>
				    <div id="panel1a" class="content">
                        <ul class="gs-canvas-list" id="areas">
                            <li data-name="area"><span class="round label" data-name="code">AE</span>
                              <input type='checkbox' id="ch1" />
                              <label for="ch1"></label>
                              <span data-name="name">Artes Escénicas</span>
                              <ul>
                                <li data-name="description">Ej. Teatro, Danza, Performance, Circo, Títeres, etc...</li>
                              </ul>
                            </li>
                        </ul>
				    </div>
				  </li>

				  <!-- accordion two -->
				  <li class="accordion-navigation">
				    <a href="#panel2a">Ciudad</a>
				    <div id="panel2a" class="content">
                        <ul class="gs-canvas-list" id="cities">
                            <li data-name="city">
                                <input type='checkbox' id="ch1" />
                                <label for="ch1"></label>
                                <span data-name="name">Artes Escénicas</span>
                            </li>
                        </ul>
				    </div>
				  </li>

				  <!-- accordion three -->
				  <li class="accordion-navigation">
				    <a href="#panel3a">Fechas</a>
				    <div id="panel3a" class="content">
						  <div class="row">
						    <div class="small-9">
						      <div class="row">
						        <div class="small-3 columns">
						          <label for="begins" class="right">De</label>
						        </div>
						        <div class="small-6 columns">
						          <input type="text" id="begins" placeholder="">
						        </div>
                                <div class="small-1 columns">
                                  <i class="fa fa-calendar"></i>
                                </div>
						      </div>
						      <div class="row">
						        <div class="small-3 columns">
						          <label for="ends" class="right">Hasta</label>
						        </div>
						        <div class="small-6 columns">
						          <input type="text" id="ends" placeholder="">
						        </div>
                                <div class="small-1 columns">
                                    <i class="fa fa-calendar"></i>
                                </div>
						      </div>
						    </div>
						  </div>
				    </div>
				  </li>

				</ul>
                <div class="row">
                  <button class="button expand gs-btn" onclick="updateMap();">Buscar</button>
                </div>
				<!-- end accordion -->
      </aside>
      <section>
      	<!-- map -->
			  <div id="map">
				  <div id="popup"></div>
			  </div>
      </section>
   </div>

	<script>

        var search = function(data) {
            $.ajax({
                url: "/api/localizations",
                type: 'post',
                dataType: 'json',
                data: JSON.stringify(data),
                contentType: "application/json; charset=utf-8",
                success: function(response) {
                    vectorSource.clear();
                    $.each(response.locs, function(i,e){
                        if (e.geoLatLng){
                            var marker = new ol.Feature({
                                name: e.festivalName + "<br/ ><a href='"+ e.url+"'>Detalles</a>",
                                geometry: new ol.geom.Point([e.geoLatLng.lat, e.geoLatLng.long]),
                                style: iconStyle
                            });
                            marker.setStyle(iconStyle);
                            marker.on('click', function(){ console.log('over')}, marker);
                            vectorSource.addFeature(marker);
                        }
                    });
                }
		    });
        };

        var updateMap = function() {
          console.log("MAP");
          var areas = [];
          $('#areas input:checked').each(function() {
            areas.push($(this).attr('id'));
          });
          var cities = [];
          $('#cities input:checked').each(function() {
            cities.push($(this).attr('id'));
          });
          var begins = $('#begins').val();
          var ends = $('#ends').val();
          search({ 'areas': areas, 'cities': cities, 'begins': begins, 'ends': ends });
        };

        $(document).ready(function(){
          $('#begins').fdatepicker();
          $('#ends').fdatepicker();
        });

		var iconStyle = new ol.style.Style({
			image: new ol.style.Icon(({
				anchor: [0.5, 46],
				anchorXUnits: 'fraction',
				anchorYUnits: 'pixels',
				opacity: 0.75,
				src: '/img/marker-icon.png'
			}))
		});

		var vectorSource = new ol.source.Vector();
		var vectorLayer = new ol.layer.Vector({
			source: vectorSource
		});

		var projection = ol.proj.get('EPSG:900913');
		var projectionExtent = projection.getExtent();
		var size = ol.extent.getWidth(projectionExtent) / 256;
		var resolutions = new Array(26);
		var matrixIds = new Array(26);
		for (var z = 0; z < 26; ++z) {
			// generate resolutions and matrixIds arrays for this WMTS
			resolutions[z] = size / Math.pow(2, z);
			matrixIds[z] = 'EPSG:900913:' + z;
		}

		var map = new ol.Map({
			layers: [
				new ol.layer.Tile({
					source: new ol.source.OSM()
				}),
				vectorLayer
			],
			renderer: 'canvas',
			target: document.getElementById('map'),
			view: new ol.View({
				center: [-7354864, -1889219],
				zoom: 5
			})
		});

		//Añadimos un control de zoom

		map.addControl(new ol.control.ZoomSlider());

		var element = document.getElementById('popup');

		var popup = new ol.Overlay({
			element: element,
			positioning: 'bottom-center',
			stopEvent: false
		});
		map.addOverlay(popup);

		// display popup on click
		map.on('click', function(evt) {
			console.log("click en el map", evt);

			map.forEachFeatureAtPixel(evt.pixel, function(feature, layer) {
				//return feature;
				if (feature) {
					var geometry = feature.getGeometry();
					var coord = geometry.getCoordinates();
					popup.setPosition(coord);
					$(element).popover('destroy');
					$(element).popover({
						placement: 'top',
						html: true,
						content: feature.get('name')
					});
					$(element).popover('show');
				} else {
					$(element).popover('destroy');
				}
			});

		});

		map.on('pointermove', function(e) {
			if (e.dragging) {
				$(element).popover('destroy');
				return;
			}
			var pixel = map.getEventPixel(e.originalEvent);
			var hit = map.hasFeatureAtPixel(pixel);
			map.getTarget().style.cursor = hit ? 'pointer' : '';
		});

		search({});

	</script>

</div>
