<!doctype html>
<html class="no-js" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Foundation | Welcome</title>
  <link rel="stylesheet" href="/css/foundation.css" />
  <link rel="stylesheet" href="/css/fullcalendar.min.css" />
  <link rel="stylesheet" href="/css/gs_styles.css" />
  <link rel="stylesheet" href="/css/media.css" />
  <link rel="stylesheet" href="/css/ol.css" />
  <link rel="stylesheet" href="/css/foundation-datepicker.css" />
  <link rel="stylesheet" href="/css/tagmanager.css" />
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <link href="/css/vendor/lightbox2/lightbox.css" rel="stylesheet" />

  <script src="/js/vendor/modernizr.js"></script>
  <script src="/js/script.js"></script>
  <script src="/js/tagmanager.js"></script>
  <script src="/js/vendor/jquery.ui.widget.js"></script>
  <script src="/js/jquery.iframe-transport.js"></script>
  <script src="/js/jquery.fileupload.js"></script>
  <script src="/js/vendor/lightbox2/lightbox.min.js"></script>

	<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
	<style>
		#map { height: 580px; }
	</style>
</head>

<body>


<nav role="navigation" data-topbar="" class="top-bar">
  <ul class="title-area">
    <li class="name"><h1><a href="/"><img src="/img/logo_festivalesenred.png"></a></h1></li>
    <li class="toggle-topbar menu-icon"><a href="#"><span>Menu</span></a></li>
  </ul>

  <section class="top-bar-section">
    <ul data-lift="Menu.builder?group=topbar;ul:class=left"></ul>
    <ul data-lift="Menu.builder?group=usertopbar;ul:class=right;"></ul>
    <ul class="right telardes">
      <li><a href="http://www.telartes.org.bo" target="_blank"><span class="telardes-label">Una propuesta de</span><img src="/img/telartes.png"/></a></li>
    </ul>
  </section>
</nav>

<div class="off-canvas-wrap" data-offcanvas id="content">

</div>



<script src="/js/foundation.min.js"></script>
<script src="/js/vendor/moment.min.js"></script>
<script src="/js/vendor/fullcalendar/fullcalendar.min.js"></script>
<script src="/js/vendor/fullcalendar/lang/es.js"></script>
<script src="/js/foundation-datepicker.js"></script>

<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
<script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>

<script>
  $(document).foundation();
</script>

<script>

	var iconStyle = new ol.style.Style({
	  image: new ol.style.Icon(({
		anchor: [0.5, 46],
		anchorXUnits: 'fraction',
		anchorYUnits: 'pixels',
		opacity: 0.75,
		src: '/img/marker-icon.png'
	  }))
	});


	var vectorSource = new ol.source.Vector();
	var vectorLayer = new ol.layer.Vector({
	  source: vectorSource
	});

	var projection = ol.proj.get('EPSG:900913');
	var projectionExtent = projection.getExtent();
	var size = ol.extent.getWidth(projectionExtent) / 256;
	var resolutions = new Array(26);
	var matrixIds = new Array(26);
	for (var z = 0; z < 26; ++z) {
	  // generate resolutions and matrixIds arrays for this WMTS
	  resolutions[z] = size / Math.pow(2, z);
	  matrixIds[z] = 'EPSG:900913:' + z;
	}

	var map = new ol.Map({
	   layers: [
		 new ol.layer.Tile({
			source: new ol.source.OSM()
		 }),
		 vectorLayer
	   ],
	   renderer: 'canvas',
	   target: document.getElementById('map'),
	   view: new ol.View({
		 center: [-7354864, -1889219],
		 zoom: 5
	   })
	});

	//AÃ±adimos un control de zoom

	map.addControl(new ol.control.ZoomSlider());

	var element = document.getElementById('popup');

	var popup = new ol.Overlay({
	  element: element,
	  positioning: 'bottom-center',
	  stopEvent: false
	});
	map.addOverlay(popup);

	// display popup on click
	map.on('click', function(evt) {
		console.log("click en el map", evt);

	  	map.forEachFeatureAtPixel(evt.pixel, function(feature, layer) {
				//return feature;
			  	if (feature) {
					var geometry = feature.getGeometry();
				  	var coord = geometry.getCoordinates();
				  	popup.setPosition(coord);
				  	$(element).popover('destroy');
				  	$(element).popover({
						placement: 'top',
					  	html: true,
					  	content: feature.get('name')
				  	});
				  	$(element).popover('show');
			  	} else {
					$(element).popover('destroy');
			  	}
		  	});

	});

	map.on('pointermove', function(e) {
	  if (e.dragging) {
		$(element).popover('destroy');
		return;
	  }
	  var pixel = map.getEventPixel(e.originalEvent);
	  var hit = map.hasFeatureAtPixel(pixel);
	  map.getTarget().style.cursor = hit ? 'pointer' : '';
	});


	$.ajax({url: "api/localizations",
		dataType: "json",
		success: function(response){
			console.log("server response:", response);
			$.each(response.locs, function(i,e){
				if (e.geoLatLng){
					console.log(e.geoLatLng);
					var marker = new ol.Feature({
						name: e.name + "<br/ ><a href='"+ e.url+"'>Detalles</a>",
						geometry: new ol.geom.Point([e.geoLatLng.lat, e.geoLatLng.long]),
						style: iconStyle
					});
					marker.setStyle(iconStyle);
					marker.on('click', function(){ console.log('over')}, marker);
					vectorSource.addFeature (marker);
				}
			});
		}
	});
  	</script>



	<script>
		/*
		var map = L.map('map').setView([-7354864, -1889219], 5);
		//L.tileLayer(MB_URL, {attribution: MB_ATTR, id: 'examples.map-i875mjb7'}).addTo(map);

		L.marker([51.5, -0.09]).addTo(map)
				.bindPopup("<b>Hello world!</b><br />I am a popup.").openPopup();

		L.circle([51.508, -0.11], 500, {
			color: 'red',
			fillColor: '#f03',
			fillOpacity: 0.5
		}).addTo(map).bindPopup("I am a circle.");

		L.polygon([
			[51.509, -0.08],
			[51.503, -0.06],
			[51.51, -0.047]
		]).addTo(map).bindPopup("I am a polygon.");
		console.log(map);
		*/


        $(document).ready(function() {

            $('#calendar').fullCalendar({
                header: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'month,basicWeek,basicDay'
                },
                defaultDate: (new Date).toDateString(),
                editable: true,
                lang: "es",
                eventLimit: true,
                eventRender: function (event, element) {
                    element.attr('href', event.url);

                },
                events: '/api/feeds'
            });

        });

    </script>
</body>
</html>
